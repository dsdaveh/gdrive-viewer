---
title: "R Notebook"
output: html_notebook
---


```{r libs, message=FALSE, warning=FALSE}
library(tidyverse)
library(stringr)
library(googledrive)
library(googlesheets)
library(lubridate)
library(data.tree)
library(cowplot)
library(tictoc)
theme_set(theme_gray())
```

```{r get_files}
cached = TRUE
if (cached) {
    files <- readRDS('all.rds')
} else {
    tic()
    files <- drive_find()
    saveRDS(files, 'all.rds')
    toc()
}
```

Let's look at both count and size accumulation over time. Note that file size is only counted for files that are stored in native format (i.e. not Google Docs)

```{r plot_time}
files <- files %>% googledrive:::promote('createdTime')
plot_by_date <- files %>% 
    mutate(createdTime = ymd_hms(createdTime),
           `Cumulative Doc Count` = row_number(createdTime)) %>% 
    ggplot(aes(createdTime, `Cumulative Doc Count`, group=1)) + geom_line() + geom_point() +
    ggtitle('Accumulation by file count')

files <- files %>% googledrive:::promote('quotaBytesUsed') %>% 
    mutate(q_size = as.numeric(quotaBytesUsed))
total_size <- sum(files$q_size)

plot_by_size <- files %>% 
    arrange(createdTime) %>%
    mutate (createdTime = ymd_hms(createdTime),
            `Cumulative File Size` = cumsum(q_size)) %>% 
    ggplot(aes(createdTime, `Cumulative File Size`, group=1)) + geom_line() + geom_point() +
    ggtitle('Accumulation by file size')
plot_grid(plot_by_date, plot_by_size)
```

Interesting. There seem to be several days where a lot of files got added to my Drive. I use the Drive desktop app which automatically syncs files from my PC, so maybe I got a little careless about adding files into that folder. It's also noteworthy that the size explosion and count explosions don't always occur on the same days, so I'll need to look at those separately.  

Total quota file size is `r round(total_size / 1e9, 1)` GB.

Let's start with largest files, and see which Drive paths contain them.

```{r plot_largest}
fat_files <- files %>% 
    arrange(-q_size) %>%
    top_n(10, q_size) %>%
    drive_reveal(what = 'path') %>%
    googledrive:::promote('quotaBytesUsed') %>%  #drive_reveal crunched our dribble 
    mutate(sizeGB = round(as.numeric(quotaBytesUsed) / 1e9, 2))
fat_files %>% select(path, sizeGB)
```

There are a couple of files there I don't need or could get online, but otherwise this makes me just want to go watch a few family vids. So a little savings are possible, but nothing much overly noteworthy. The zz_GitHub looks like something I shouldn't be paying to keep around.

Let's look at the files by the chronological order they were added and look at the days with the most volume.

```{r large_files}
fat_days <- files %>% mutate(create_date = createdTime %>% as.Date() %>% as.character()) %>%
    count(create_date, sort = TRUE) %>%
    top_n(10, n)
fat_days
```

That's a lot of files. There probably some folders here that are adding a lot of unnecessary files. Looking up paths can take a long time with the `drive_reveal`. So I want to take a the approach of sampling files added on the days we just identified above. On the assumption that something caused large folders to get added to my drive, this should help me identify those.

```{r large_folders}
set.seed(199)
tic()
fat_day_sample <- files %>% 
    mutate(create_date = createdTime %>% as.Date() %>% as.character()) %>%
    semi_join(fat_days) %>%
    group_by(create_date) %>%
    mutate(shuffle = sample(n())) %>%
    top_n(10, shuffle) %>%
    drive_reveal(what = 'path')
toc()

#prune until any children of a node don't have a minimum threshold
prune_min <- 15 #Clone doesn't have ...
pruneFunction <- function(x) {
    if (isLeaf(x)) return(FALSE)
    if (x$totalCount < prune_min) return(FALSE)
    return( x$totalCount >= prune_min )
}
    
tree <- as.Node(fat_day_sample, pathName = "path")
pruned <- Clone(tree, pruneFun = pruneFunction)
print(pruned, 'totalCount', pruneMethod = 'dist', limit = NULL)
```

```{r get_folders}
cache_folders <- TRUE
if (cache_folders) {
    folders <- readRDS('folders.rds')
} else {
    tic()
    folders <- files %>% 
        drive_reveal(what = 'mime_type') %>% 
        filter(str_detect(mime_type,'apps.folder$')) %>%
        drive_reveal(what = 'path') 
    saveRDS(folders, 'folders.rds')
    toc()
}

```
```{r}
ftree <- as.Node(folders, pathName = "path")
ftree$Do(function(x) x$origCount <- x$count)
prune_min <- 10 #Clone doesn't have ...
fpruned <- Clone(ftree, pruneFun = pruneFunction)
print(fpruned, 'totalCount', 'origCount', pruneMethod = 'dist', limit = NULL)
```


